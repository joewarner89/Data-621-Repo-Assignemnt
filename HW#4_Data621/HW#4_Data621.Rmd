---
title: "HW#4_Data621"
author: "Saloua Daouki"
date: "2024-11-15"
output:
  pdf_document:
    toc: true
    toc_depth: '3'
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Loading Necessary Libraries and the data


```{r}
library(dplyr)
library(ggplot2)
library(caret)
library(car)
library(e1071)
library(MASS)
```

```{r}
insurance_training <- read.csv("insurance_training_data.csv")
insurance_evaluation <- read.csv("insurance-evaluation-data.csv")
```

## 1. Data Exploration:

### a. Mean / Standard Deviation / Median

```{r}
# Quick exploration
str(insurance_training)  # Structure of data
summary(insurance_training)  # Summary statistics

# Check for missing values
colSums(is.na(insurance_training))
```
 
The data has 8161 observations and 25 variables (excluding the `INDEX` which won't be used for the analysis).

The primary target variable is `TARGET_FLAG`, a binary indicator representing whether a car was in crash, and the secondary target `TARGET_AMT` indicates the amount of the cost if a car was in crash.

`AGE` has a mean of 44.8 years (SD = 14.3) with a median age of 45, indicating a balanced age distribution.
`TRAVTIME` (commute time to work) averages 33.5 minutes, with most values clustered between 22 and 44 minutes. A full table of key statistics is included above for reference.

Several variables have missing values:

- `AGE` (6 missing values), `YOJ` (454), `INCOME` (many blanks), and `CAR_AGE` (510).
We are going to apply imputation strategies to address these gaps. Missing AGE values will be replaced with the median (45 years).

- `YOJ` and `CAR_AGE` will be imputed using their median values (11 and 8 years, respectively).
`INCOME`, recorded as character strings, will be cleaned and converted to numeric, with missing values replaced by the median.

### b. Bar Chart or Box Plot of the data

#### b.1. Visualize Numeric Variables

```{r}
# Histogram for AGE
ggplot(insurance_training, aes(x = AGE)) +
  geom_histogram(bins = 30, fill = "skyblue", color = "black") +
  labs(title = "Age Distribution", x = "Age", y = "Frequency")

# Boxplot for CAR_AGE
ggplot(insurance_training, aes(y = CAR_AGE)) +
  geom_boxplot(fill = "lightgreen") +
  labs(title = "Boxplot of CAR_AGE", y = "Car Age")

# Checking correlation between numeric features
numeric_vars <- sapply(insurance_training, is.numeric)
correlation_matrix <- cor(insurance_training[, numeric_vars], use = "pairwise.complete.obs")
print(correlation_matrix)
```
The histogram for the variable `AGE` shows an approximately normal distribution, with the highest frequency occurring around the median age of 45.

For `CAR_AGE`, outliers were evident, with the minimum value being -4, indicating that a negtive age doesn't make sense. 

A correlation matrix highlighted several key relationships:

- The target variable `TARGET_FLAG` has a moderate positive correlation with `MVR_PTS` (Motor Vehicle Record Points, 0.22) and `CLM_FREQ` (Claim Frequency, 0.22). These variables are strong candidates for inclusion in the logistic regression model.

- `AGE` and `CAR_AGE` exhibit weak negative correlations with `TARGET_FLAG` (-0.10 each), suggesting limited predictive value.

- `TARGET_AMT` is moderately correlated with `TARGET_FLAG` (0.53), as expected, since claim amounts/cost depend on whether a claim was filed for a crashed car.

#### b.2. Visualize Categorical Variables:

```{r}
# Bar plot for CAR_TYPE
ggplot(insurance_training, aes(x = CAR_TYPE)) +
  geom_bar(fill = "purple") +
  labs(title = "Car Type Distribution", x = "Car Type", y = "Count") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Bar plot for TARGET_FLAG
ggplot(insurance_training, aes(x = factor(TARGET_FLAG))) +
  geom_bar(fill = "orange") +
  labs(title = "Target Flag Distribution", x = "Target Flag (0 = No Crash, 1 = Crash)", y = "Count")
```
Vehicle Types: The dataset includes a variety of vehicle categories, with the most common being SUVs (Z_SUV), accounting for 2,260 entries, followed by:

- Minivans: 2,020 entries

- Pickup Trucks: 1,375 entries

- Sports Cars: 875 entries

- Vans: 750 entries

- Panel Trucks: 700 entries

This distribution highlights a predominance of family-oriented and utility vehicles, potentially influencing claim tendencies.

Target Flag Distribution: The target variable TARGET_FLAG has a highly imbalanced distribution:

- No Crash (0): 6,000 instances (approximately 73.5% of the data).

- Crash (1): 2,100 instances (approximately 26.5%).

The imbalance will be considered in model development, potentially requiring techniques like weighting, oversampling, or undersampling to ensure accurate prediction.

## 2. Data Preparation:

### a. Handling Missing Values:

Since the variables that have missing values are numeric, we are going to impute the missing values using the median.

```{r}
# Impute missing values for numerical variables with median
numeric_vars <- sapply(insurance_training, is.numeric)
insurance_training[numeric_vars] <- lapply(insurance_training[numeric_vars], function(x) ifelse(is.na(x), median(x, na.rm = TRUE), x))
```

### b. Creating Flags for Missing Values:

```{r}
# Loop through all variables to create flags for missing values
for (var in colnames(insurance_training)) {
  insurance_training[paste0(var, "_FLAG")] <- ifelse(is.na(insurance_training[[var]]), 1, 0)
}

# Check the new flags columns
head(insurance_training)
```

- The paste0(var, "_FLAG") dynamically creates the name for the new flag column based on the original variable name (e.g., if the original variable is AGE, the flag column will be AGE_FLAG).

- ifelse(is.na(insurance_training[[var]]), 1, 0) checks if the value is missing (NA), and if it is, it assigns a 1; otherwise, it assigns a 0.

### c. Transforming data by putting it into buckets:

In this sub-section, we are going to bucketize the continuous variables; `AGE` and `TARGET_AMT`:

```{r}
# Bucketize AGE into ranges
insurance_training$AGE_BUCKET <- cut(insurance_training$AGE,
                                breaks = c(18, 30, 50, 70, Inf),
                                labels = c("18-30", "31-50", "51-70", "70+"))

# Bucketize TARGET_AMT into categories
insurance_training$TARGET_AMT_BUCKET <- cut(insurance_training$TARGET_AMT,
                                       breaks = c(0, 1000, 5000, 10000, Inf),
                                       labels = c("0-1000", "1001-5000", "5001-10000", "10000+"))

# Check the bucketized varaibles
table(insurance_training$AGE_BUCKET)
table(insurance_training$TARGET_AMT_BUCKET)
```
By bucketizing `AGE` into discrete categories, it makes the variable easier to interpret and analyze. Similarly, bucketizing `TARGET_AMT` helps transform a continuous variable with potentially high variation into manageable categories. This can help with clearer reporting and analysis of trends.

### d. Mathematical transforms such as log or square root (or use Box-Cox):

First and to have a clear decision about the type of transformation based on the skewness of each variable:

```{r}
# Check skewness for numeric variables
skew_values <- sapply(insurance_training[, c("AGE", "CAR_AGE", "TARGET_AMT", "KIDSDRIV", "HOMEKIDS")], skewness, na.rm = TRUE)

# View skewness values
print(skew_values)
```

Interpretations: 

- `AGE`: -0.03
This value is close to 0, indicating that the AGE variable is approximately normally distributed. No transformation is needed.

- `CAR_AGE`: 0.30
The skewness of CAR_AGE is slightly positive, but it is relatively close to 0, meaning it is only mildly skewed. We may not need a transformation for this variable, as the skewness is not severe. 

- `TARGET_AMT`: 8.71
This is highly positively skewed, with a skewness greater than 1. This suggests that TARGET_AMT has a long right tail, which is typical for monetary data. **A log transformation** would be helpful in normalizing this variable.

- `KIDSDRIV`: 3.35
This has significant positive skewness, but itâ€™s not extreme. If you want to reduce the skewness, you could consider a log transformation, but it might not be absolutely necessary if the model can handle the skewness well.

- `HOMEKIDS`: 1.34
This value also indicates mild positive skewness. Similar to CAR_AGE, no transformation is strictly necessary, but a log transformation could slightly improve the distribution, especially if we are aiming for perfect normality.


Now, based on the skewness above, we only need to log-transform the `TARGET_AMT`, and the other two variables that have a slight high skewness:

```{r}
# Apply log transformation to TARGET_AMT amd the others
insurance_training$TARGET_AMT_LOG <- log(insurance_training$TARGET_AMT + 1)

insurance_training$KIDSDRIV_LOG <- log(insurance_training$KIDSDRIV + 1)
insurance_training$HOMEKIDS_LOG <- log(insurance_training$HOMEKIDS + 1)
```

Let's check the skewness values after the transformations we performed above:

```{r}
# Check skewness after applying the transformations
skew_values_after_transformation <- sapply(insurance_training[, c("AGE", "CAR_AGE", "TARGET_AMT_LOG", "KIDSDRIV_LOG", "HOMEKIDS_LOG")], skewness, na.rm = TRUE)

# View the skewness values after transformation
print(skew_values_after_transformation)
```

That is good progress;

- The log transformation on `TARGET_AMT` has reduced the skewness significantly, but it remains moderately skewed. This is typical for monetary variables. The transformation has improved the distribution but could still benefit from further adjustments.

- The transformation on `KIDSDRIV` has reduced the skewness but it is still quite positive. This suggests that the log transformation helped, but the variable is still somewhat skewed. We should consider another transformation.

- The log transformation on `HOMEKIDS` has reduced the skewness to a more acceptable level, bringing it closer to zero. This variable is now much more normally distributed and ready for modeling.

One additional tranformation that can help us normalize the continuous variable `TARGET_AMT`is Box-Cox Transformation

```{r}
insurance_training$TARGET_AMT_SHIFTED <- insurance_training$TARGET_AMT + 1
boxcox_result <- boxcox(TARGET_AMT_SHIFTED ~ 1, data = insurance_training)
lambda <- boxcox_result$x[which.max(boxcox_result$y)]
insurance_training$TARGET_AMT_BOXCOX <- (insurance_training$TARGET_AMT_SHIFTED^lambda - 1) / lambda
```

we can also perform the square root transformation:

```{r}
insurance_training$TARGET_AMT_SQRT <- sqrt(insurance_training$TARGET_AMT)
```

Let's do the same thing for the variable `KIDSDRIV`:

First, Box-Cox:

```{r}
insurance_training$KIDSDRIV_BOXCOX <- (insurance_training$KIDSDRIV + 1)^lambda - 1
```

Then, we can use Cube Root transformation:

```{r}
insurance_training$KIDSDRIV_CUBE <- sign(insurance_training$KIDSDRIV) * abs(insurance_training$KIDSDRIV)^(1/3)
```

Let's check once more for after-transformations-skewness 

```{r}
# Check skewness after applying the transformations
skew_values_after_transformation2 <- sapply(insurance_training[, c("AGE", "CAR_AGE", "TARGET_AMT_BOXCOX", "KIDSDRIV_BOXCOX", "HOMEKIDS_LOG")], skewness, na.rm = TRUE)

# View the skewness values after transformation
print(skew_values_after_transformation2)
```

```{r}
# Check skewness after applying the transformations
skew_values_after_transformation3 <- sapply(insurance_training[, c("AGE", "CAR_AGE", "TARGET_AMT_SQRT", "KIDSDRIV_CUBE", "HOMEKIDS_LOG")], skewness, na.rm = TRUE)

# View the skewness values after transformation
print(skew_values_after_transformation3)
```

Based on the transformations above:

- `TARGET_AMT`: Box-Cox was more effective in reducing skewness compared to the square root or cube transformations. While for `KIDSDRIV`, Box-Cox made the variable more negatively skewed, whereas cube transformation made it more positively skewed. Neither transformation worked well. So we better keep the _CUBE or find another approach for this variable.

### e. Creating New Variables:

Age-based Grouping (AGE_GROUP): Age is a continuous variable, but for the purposes of analysis and modeling, grouping it into categories allows us to better understand trends in different age ranges. For example, it might be valuable to compare the behavior of individuals in their 20s versus those in their 50s when it comes to claims or risk.

```{r}
# Create age groups
insurance_training$AGE_GROUP <- cut(insurance_training$AGE, 
                               breaks = c(18, 30, 50, Inf), 
                               labels = c("18-30", "31-50", "51+"))
```

Creating Ratio Variable (KIDSDRIV_RATIO)

```{r}
# Create a new variable as the ratio of KIDSDRIV to AGE
insurance_training$KIDSDRIV_RATIO <- insurance_training$KIDSDRIV / insurance_training$AGE
```



