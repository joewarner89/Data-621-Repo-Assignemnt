---
title: "HW#5_Data621"
author: "Saloua Daouki"
date: "2024-12-01"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

This analysis focuses on exploring, analyzing, and modeling a dataset of approximately 12,000 commercially available wines. The dataset primarily includes variables related to the chemical properties of the wines being sold. The target variable represents the number of sample cases of wine purchased by wine distribution companies after sampling a wine. These sample cases are used by distribution companies to provide tasting samples to restaurants and wine stores across the United States. Wines with higher sample case purchases are more likely to be featured in high-end restaurants.

The goal of this assignment is to build **a count regression model** to predict the number of sample cases purchased based on the wine's characteristics. Accurate predictions would enable the wine manufacturer to adjust its wine offerings to maximize sales. Additionally, it's worth considering that missing values in the dataset may hold predictive value for the target variable. For this analysis, only the provided variables (or those derived from them) will be utilized.

Below is the exploratory analysis of the dataset:

```{r}
# Load necessary libraries
library(ggplot2)
library(dplyr)
library(corrplot)
library(readr)
```

## 1. Data Exploration:

```{r}
# Load datasets
training_wine_data <- read_csv("wine-training-data.csv")
evaluation_wine_data <- read_csv("wine-evaluation-data.csv")
```
The evaluation data has 3335 observations with 16 variables. The training data has 12795 observations with also 16 variables.

The message above indicates that the variable 'TARGET' is numerical in the training data where is logical in the evaluation data. This will create an error in later analysis if it is not addressed now; we are going to convert the 'TARGET' to numercial in the evaluation data.

```{r}
# convert TARGET to numerical in the evaluation data and ensure that it is the same in training data
evaluation_wine_data$TARGET <- as.numeric(evaluation_wine_data$TARGET)
training_wine_data$TARGET <- as.numeric(training_wine_data$TARGET)
```

Next, let's look at the summary statistics and the structure of the training data:

```{r}
# Explore dataset
summary(training_wine_data)
str(training_wine_data)
```

Several variables (such as ResidualSugar, Chlorides, FreeSulfurDioxide, TotalSulfurDioxide, pH, Sulphates, Alcohol, and STARS) in the data contain NA values which could potentially be a concern when we perform model fitting, as some models require imputation or removal of rows with missing data. This we will handle in data preparation section.

```{r}
# Mean, Median, Standard Deviation
summary_stats <- training_wine_data %>%
  summarise(across(where(is.numeric), list(
    mean = ~ mean(.x, na.rm = TRUE),
    sd = ~ sd(.x, na.rm = TRUE),
    median = ~ median(.x, na.rm = TRUE)
  )))
summary_stats
```
-   The `TARGET` variable -Number of Cases Purchased - has mean and median that are close, indicating a roughly symmetric distribution. The standard deviation shows some variation around the mean.

-   `FixedAcidity` has a large standard deviation compared to its mean and median, suggesting high variability in acidity values across the samples.

-   before building any model, we want to explore how these variables relate to each other and how they influence `TARGET`. In addition, the large spread in `FixedAcidity` could indicate that transformations (e.g., log-transformation) may be helpful to stabilize variance.








```{r}
# Visualizations
# Boxplot for target variable
ggplot(training_wine_data, aes(x = "", y = TARGET)) +
  geom_boxplot() +
  labs(title = "Boxplot of Target Variable", y = "Number of Cases Sold")
```

```{r}
# Correlation matrix
numeric_vars <- training_wine_data %>% select(where(is.numeric))
cor_matrix <- cor(numeric_vars, use = "complete.obs")
corrplot(cor_matrix, method = "circle")
```

```{r}
# Check missing values
missing_values <- sapply(training_wine_data, function(x) sum(is.na(x)))
missing_values
```


## 2. Data Preparation:



```{r pressure, echo=FALSE}
# Fix missing values with median
training_data <- training_data %>%
  mutate(across(where(is.numeric), ~ ifelse(is.na(.), median(., na.rm = TRUE), .)))

# Create missing flags
missing_flags <- training_data %>%
  summarise(across(everything(), ~ sum(is.na(.))))
training_data <- training_data %>%
  mutate(across(everything(), list(flag = ~ as.integer(is.na(.)))))

# Log transform example
training_data <- training_data %>%
  mutate(log_target = log1p(target_variable))

# Combine variables (example: interaction term)
training_data <- training_data %>%
  mutate(acidity_ratio = fixed_acidity / volatile_acidity)

```


## 3. Build Models

Build the required models using glm, MASS::glm.nb, and standard linear regression.

```{r}
# Poisson regression models
poisson_model1 <- glm(target_variable ~ ., family = poisson(link = "log"), data = training_data)
poisson_model2 <- glm(target_variable ~ log_target + acidity_ratio, family = poisson(link = "log"), data = training_data)

# Negative Binomial models
library(MASS)
nb_model1 <- glm.nb(target_variable ~ ., data = training_data)
nb_model2 <- glm.nb(target_variable ~ log_target + acidity_ratio, data = training_data)

# Linear regression models
lm_model1 <- lm(target_variable ~ ., data = training_data)
lm_model2 <- lm(target_variable ~ log_target + acidity_ratio, data = training_data)

# Compare coefficients
summary(poisson_model1)
summary(nb_model1)
summary(lm_model1)
```

## 4. Select Models

Choose the best models based on evaluation metrics such as AIC, residual deviance, or adjusted RÂ².

```{r}
# Model comparison
models <- list(poisson_model1, poisson_model2, nb_model1, nb_model2, lm_model1, lm_model2)
model_aic <- sapply(models, AIC)

# Select the best count regression model
best_model <- nb_model1  # Replace with your choice based on AIC or other metrics

# Evaluate performance
predictions <- predict(best_model, newdata = evaluation_data, type = "response")
```

